# Camera Streaming Daemon

[![Build Status](https://travis-ci.org/01org/camera-streaming-daemon.svg?branch=master)](https://travis-ci.org/01org/camera-streaming-daemon)
<a href="https://scan.coverity.com/projects/01org-camera-streaming-daemon">
  <img alt="Coverity Scan Build Status"
       src="https://scan.coverity.com/projects/12056/badge.svg"/>
</a>

## Pre-Requisites
In order to compile you need the following packages:

 - GCC/G++ compiler 4.9 or newer
 - C and C++ standard libraries
 - GLib 2.42 or newer (https://wiki.gnome.org/Projects/GLib)
 - Avahi 0.6 or newer (https://github.com/lathiat/avahi)
 - GStreamer 1.4 or newer (https://gstreamer.freedesktop.org/)
 - GStreamer RTSP Server 1.4 or newer (https://gstreamer.freedesktop.org/modules/gst-rtsp-server.html)
 - Python2

### Installing Pre-Requisites on Ubuntu

The following commands should install many of these required packages on Ubuntu:

    $ sudo apt-get install libavahi-client-dev libavahi-core-dev libavahi-glib-dev
    $ sudo apt-get install gstreamer-1.0
    $ sudo apt-get install libgstreamer-plugins-base1.0-dev
    $ sudo apt-get install libgstrtspserver-1.0-dev
    $ sudo pip2 -q install -U future

## Fetch source-code: ##

Clone the repo:
     
    $ git clone https://github.com/intel/camera-streaming-daemon.git

## Fetch dependencies: ##

We currently depend on mavlink C library which is generated by the build
system during compilation. The corresponding submodule should be fetched.

    $ git submodule update --init --recursive

## Build and Install

Build system follows the usual configure/build/install cycle. Configuration is needed to be done only once. A typical configuration is shown below:

    $ ./autogen.sh && ./configure

In order to build for aero, use --enable-aero option along with ./configure:

    $ ./autogen.sh && ./configure --enable-aero --enable-mavlink  or
    $ ./autogen.sh && ./configure --enable-aero --enable-avahi  or
    $ ./autogen.sh && ./configure --enable-aero --enable-mavlink --enable-avahi

In order to build for ubuntu use one of the following:

    $ ./autogen.sh && ./configure --enable-mavlink  or
    $ ./autogen.sh && ./configure --enable-avahi  or
    $ ./autogen.sh && ./configure --enable-mavlink --enable-avahi  

In order to build for ubuntu with PX4-SITL Gazebo:

    $ ./autogen.sh && ./configure --enable-mavilnk --enable-gazebo
       

By default systemd integration is enabled. In a system without systemd it can
be disabled --disable-systemd. The default systemd system directory
is taken via pkg-config. To use another directory update the above
path, use --with-systemdsystemunitdir.


Installation location can be changed using --prefix option while configuring.

Build:

    $ make

Install:

    $ make install
    $ # or... to another root directory:
    $ make DESTDIR=/tmp/root/dir install

## Running

### Configuration files

It's possible to use a .conf file to set custom options for Camera Streaming Daemon (csd). By default, csd looks for a file /etc/csd/main.conf. File location can be overridden via CSD_CONF_FILE  environment variable, or via -c switch when running csd. Sample conf file can be found on [samples/config_files](https://github.com/intel/camera-streaming-daemon/tree/maste/samples/config_files)

To run csd on ubuntu with only avahi enabled or in default mode use

    $ ./csd -c config_ubuntu.conf

To run csd on ubuntu along with gazebo PX4-SITL use:

    $ ./csd -c config_gazebo.conf

The csd is a part of Intel Aero image and the conf file is placed in /etc/csd.

## Testing on Ubuntu machine ##

1) Run mavlink enabled csd and verify wether all the camera connected to the ubuntu system are listed by csd.

        $ ./csd -v -c config_ubuntu.conf

2) Testing of video streaming can be done using a vlc player or a gstreamer client pipeline or a QGroundcontrol app.

   To test video streaming using vlc: 

        $ vlc rtsp://127.0.0.1:8554/videox

   To test video streaming using gstreamer client pipeline:

        $ gst-launch-1.0 uridecodebin uri=127.0.0.1:8554/videox

   In order to test the video streaming using QGC, select RTSP Video Source in General Setting-> Video ->Video Source and fill in uri as rtsp://127.0.0.1:8554/videox. Observe the video in video area in fly  view.

3) Testing Control Actions:

   Testing control action requires mavlink enabled csd, a QGC app build from master and a http server (Follow https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-16-04 to install apache server).

   (i) Host the camera definition file present in samples directory using http server. To host using apache server copy the file to /var/www/html:
 
        $ cp ~/camera-streaming-daemon/samples/camera-def-rs-rgb.xml /var/www/html/

   (ii) Open QGC build from master. Select General Settings->Video Source -> RTSP Video Stream. Fill in the video uri and observe the video in fly view. 

   (iii) In fly view, select camera from dropdown list located in top right corner under compass. Settings button in left top corner of the box can be used to set the control parameters of the camera.

4) Testing Image capture:

   Testing image capture requires mavlink enabled csd and a QGC app build from master.

   (i) In QGC, disable the video streaming: General Settings->Video Source -> Video Stream Disabled.

   (ii) Create a directory to store the image and update the location in imgcap section of conf file.

   (iii) Now, in fly view select camera mode and click on red button to take an image. The image will be stored in the location given in imgcap section in conf file.

## Testing on Aero:

   Camera streaming daemon is a part if Intel Aero image. A conf file is present by default in /etc/csd/main.conf, which can be edited appropriately by referring to sample conf file, config_aero.conf, in config_files folder in samples directory.

1) Make sure csd is running on aero:

        $ systemctl status csd

2) To see the list of cameras connected to aero avahi-browse can be used provided avahi is enabled.

        $ avahi-browse -all | grep _rtsp._udp

3) Testing the video streaming can be done using a vlc player/ gstreamer client pipeline or a QGroundcontrol app.

   To test video streaming using vlc:

        $ vlc rtsp://<drone ip>:8554/videox

   To test video streaming using gstreamer pipeline:

       $ gst-launch-1.0 uridecodebin uri=<ip of drone>:8554/videox

   In order to test the videostreaming using QGC select RTSP Video Source in General Setting-> Video ->Video Source and fill in uri as rtsp://drone ip:8554/videox. Observe the video in video area in fly view.

4) Testing Control Actions:

   Testing control action requires mavlink enabled csd and a QGC app build from master. 

   (i) The aero image has an aero-http server to host camera definition file. Copying the camera defenition files to /var/http will host the files.

   (ii) Open QGC build from master. Select General Settings->Video Source -> RTSP Video Stream. Fill in the video uri and observe the video in fly view.

   (iii) In fly view, select camera from dropdown list located in top right corner under compass. Settings button in left top corner of the box can be used to set the control parameters of the camera.

5) Testing Image Capture:

   Testing image capture requires mavlink enabled csd and a QGC app build from master.

    (i) In QGC disable the video streaming: General Settings->Video Source -> Video Stream Disabled.

    (ii) Create a directory to store the image and update the location in imgcap section of conf file.

    (iii) Now, in fly view select camera mode and click on red button to take an image. The image will be stored in the location given in imgcap section in conf file.

## Testing on ubuntu with PX4-SITL Gazebo:

1) Open QGC app build from master branch

2) Start PX4-SITL gazebo:

        $ cd ~
        $ git clone https://github.com/PX4/Firmware.git
        $ cd ~/Firmware
        $ git submodule update --init --recursive

  In file PX4-Firmware_folder/posix-configs/SITL/init/ekf2/typhoon_h480

    $ -mavlink start -x -u 14556 -r 4000000
    $ +mavlink start -x -u 14556 -r 4000000 -f
    $ +mavlink start -x -u 24550 -f -o 34550

    $ make posix gazebo_typhoon_h480


3) Run csd with mavlink and gazebo enabled:

        $ ./csd -v -c config_gazebo.conf

4) In QGC app select camera mode and click on red button to take an image. The image will be stored in the location given in imgcap section in conf file.


## Sample

### Running the sample
In camera-streaming-daemon samples repository there is one sample to list all drone's video stream found.
The first step to build the samples:

    $ make samples

And then in a computer connected to the target drone using WiFi or any other Ethernet connection:

    $ ./samples/camera-sample-mavlink-client

More information about the camera-sample-mavlink-client is located in [[samples|Samples#camera-sample-mavlink-client]] wiki page.

## Contributing

Pull-requests are accepted on GitHub. Make sure to check coding style with the
provided script in tools/checkpatch, check for memory leaks with valgrind and
test on real hardware.

### Valgrind

In order to avoid seeing a lot of glib and gstreamer false positives memory leaks it is recommended to run valgrind using the followind command:
    $ GDEBUG=gc-friendly G_SLICE=always-malloc valgrind --suppressions=valgrind.supp --leak-check=full --track-origins=yes --show-possibly-lost=no --num-callers=20 ./csd
